name: Deploy to Production

on:
  push:
    branches:
      - master
      - firebase

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Compile TypeScript
        run: npx tsc --skipLibCheck --resolveJsonModule --esModuleInterop --module ESNext --moduleResolution node --outDir build -t es2020 Simulator/rabbitConsumer.ts
        continue-on-error: true
        
      - name: Validate deployment secrets
        run: |
          echo "ğŸ” Validating deployment configuration..."
          echo "============================================"
          
          all_secrets_present=true
          
          if [ -z "$SSH_PRIVATE_KEY_BASE64" ]; then
            echo "âŒ SSH_PRIVATE_KEY_BASE64 is missing"
            all_secrets_present=false
          else
            echo "âœ… SSH_PRIVATE_KEY_BASE64 is configured"
          fi
          
          if [ -z "$DEPLOY_HOST" ]; then
            echo "âŒ DEPLOY_HOST is missing"
            all_secrets_present=false
          else
            echo "âœ… DEPLOY_HOST is configured: $DEPLOY_HOST"
          fi
          
          if [ -z "$DEPLOY_USER" ]; then
            echo "âŒ DEPLOY_USER is missing"
            all_secrets_present=false
          else
            echo "âœ… DEPLOY_USER is configured: $DEPLOY_USER"
          fi
          
          if [ -z "$DEPLOY_PATH" ]; then
            echo "âŒ DEPLOY_PATH is missing"
            all_secrets_present=false
          else
            echo "âœ… DEPLOY_PATH is configured: $DEPLOY_PATH"
          fi
          
          echo "============================================"
          
          if [ "$all_secrets_present" = false ]; then
            echo ""
            echo "ğŸš¨ DEPLOYMENT FAILED: Missing required secrets!"
            echo ""
            echo "Please configure ALL the following secrets:"
            echo "Go to: https://github.com/elihaidv/bot/settings/secrets/actions"
            echo ""
            echo "Required secrets:"
            echo "  1. SSH_PRIVATE_KEY_BASE64 (your SSH private key, base64 encoded)"
            echo "  2. DEPLOY_HOST (your server hostname or IP address)" 
            echo "  3. DEPLOY_USER (your SSH username for the server)"
            echo "  4. DEPLOY_PATH (full path on server for deployment)"
            echo ""
            echo "Example values:"
            echo "  DEPLOY_HOST: 192.168.1.100 or myserver.com"
            echo "  DEPLOY_USER: root or ubuntu or your-username"
            echo "  DEPLOY_PATH: /home/user/bot or /root/bot"
            echo ""
            echo "To encode your SSH key: cat ~/.ssh/id_rsa | base64 -w 0"
            echo ""
            exit 1
          fi
          
          echo "ğŸ‰ All deployment secrets are configured!"
        env:
          SSH_PRIVATE_KEY_BASE64: ${{ secrets.SSH_PRIVATE_KEY_BASE64 }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        
      - name: Setup SSH
        run: |
          echo "ğŸ” Setting up SSH authentication..."
          echo "${{ secrets.SSH_PRIVATE_KEY_BASE64 }}" | base64 -d > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          eval $(ssh-agent -s)
          ssh-add /tmp/ssh_key
          echo "âœ… SSH key loaded successfully"
          
      - name: Add known hosts
        run: |
          echo "ğŸ”’ Adding server to known hosts..."
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… Known hosts updated"
          
      - name: Test SSH connection
        run: |
          echo "ğŸ”Œ Testing SSH connection to ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
          ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo 'âœ… SSH connection successful'; echo 'Server info:'; uname -a; echo 'Current directory:'; pwd; echo 'User:'; whoami; echo 'Disk space:'; df -h | head -3"
          
      - name: Create deploy directory
        run: |
          echo "ğŸ“ Creating deployment directory: ${{ secrets.DEPLOY_PATH }}"
          ssh -o ConnectTimeout=30 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }} && echo 'âœ… Deploy directory created/verified: ${{ secrets.DEPLOY_PATH }}'"
          
      - name: Deploy files to server
        run: |
          echo "ğŸš€ Deploying files to ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}"
          rsync -avz --progress --stats \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='*.log' \
            --exclude='.env*' \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}
          echo "âœ… Files deployed successfully"
          
      - name: Install dependencies on server
        run: |
          echo "ğŸ“¦ Installing dependencies on server..."
          ssh -o ConnectTimeout=30 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "cd ${{ secrets.DEPLOY_PATH }} && npm install --production --silent && echo 'âœ… Dependencies installed successfully'"
          
      - name: Manage PM2 process
        run: |
          echo "âš™ï¸ Managing PM2 process for rabbitConsumer..."
          ssh -o ConnectTimeout=30 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            echo 'Current PM2 status:'
            npx pm2 list || echo 'PM2 not yet running'
            echo 'Managing rabbitConsumer process...'
            if npx pm2 reload rabbitConsumer 2>/dev/null; then
              echo 'âœ… Successfully reloaded existing rabbitConsumer process'
            else
              echo 'Starting new rabbitConsumer process...'
              npx pm2 start Simulator/rabbitConsumer.js --name rabbitConsumer
              echo 'âœ… Successfully started new rabbitConsumer process'
            fi
            echo 'Final PM2 status:'
            npx pm2 list
            npx pm2 save
          "
          
      - name: Verify deployment
        run: |
          echo "âœ… Verifying deployment..."
          ssh -o ConnectTimeout=30 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            echo 'Deployment verification:'
            echo 'ğŸ“ Directory contents:'
            ls -la | head -10
            echo 'ğŸ“¦ Package.json exists:'
            test -f package.json && echo 'âœ… package.json found' || echo 'âŒ package.json missing'
            echo 'ğŸ”§ Node modules:'
            test -d node_modules && echo 'âœ… node_modules installed' || echo 'âŒ node_modules missing'
            echo 'âš™ï¸ PM2 process status:'
            npx pm2 show rabbitConsumer || echo 'Process not found'
          "
          
      - name: Deployment success
        run: |
          echo ""
          echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "============================================"
          echo "âœ… Code deployed to: ${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}"
          echo "âœ… Dependencies installed"
          echo "âœ… PM2 process running: rabbitConsumer"
          echo "âœ… Server ready for production"
          echo ""
          echo "ğŸ”— Server: ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
          echo "ğŸ“ Path: ${{ secrets.DEPLOY_PATH }}"
          echo ""
          
      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/ssh_key
          echo "ğŸ§¹ Cleanup completed"